name: Semantic Release Job

on:
  workflow_call:
    inputs:
      dry_run:
        type: boolean
        default: false
        description: "Executar em modo simulação"
    outputs:
      version:
        description: "Nova versão gerada"
        value: ${{ jobs.semrel.outputs.version }}
      changed:
        description: "Indica se houve mudança na versão"
        value: ${{ jobs.semrel.outputs.changed }}

jobs:
  semrel:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.release.outputs.version }}
      changed: ${{ steps.release.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref || github.ref_name }}
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Instalar semantic-release
        run: |
          pip install python-semantic-release==7.34.6
          semantic-release --version

      # Modo dry-run (para PRs)
      - name: Simular versionamento
        if: inputs.dry_run
        id: preview
        run: |
          echo "Simulando em branch: $(git branch --show-current)"
          # Forçar a branch como 'main' temporariamente para a simulação
          CURRENT_BRANCH=$(git branch --show-current)
          git checkout -b temp-main
          semantic-release version --no-commit --no-push --no-tag --skip-build --verbose
          VERSION=$(semantic-release --noop)
          git checkout $CURRENT_BRANCH
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Preview da versão: $VERSION"

      # Modo real (para main)
      - name: Executar versionamento
        if: ${{!inputs.dry_run}}
        id: release
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          echo "Executando em branch: $(git branch --show-current)"
          RESULT=$(semantic-release publish --verbose)
          VERSION=$(semantic-release --noop)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "changed=true" >> $GITHUB_OUTPUT
